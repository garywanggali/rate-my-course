# 应用的用户登录与授权实现（中文说明）

## 1. 浏览器端：Cookie 与 AJAX 如何携带授权

- 核心 Cookie：
  - `sessionid`：会话标识，浏览器在后续所有请求中自动携带，用于识别登录态
  - `csrftoken`：CSRF 防护令牌，所有修改状态的请求必须校验
- 表单与 AJAX：
  - 表单在模板中插入 CSRF：`templates/login.html:10–21`
  - AJAX 在请求头设置 `X-CSRFToken`：`templates/course_detail.html` 收藏脚本处

示例代码片段：

```
<!-- 登录表单，自动携带 CSRF，提交到 login 路由 -->
<form method="POST" action="{% url 'login' %}">
    {% csrf_token %}
    <input type="text" name="username" required>
    <input type="password" name="password" required>
    <button type="submit">登录</button>
 </form>
```

```
// 收藏 AJAX：携带 X-CSRFToken，同时浏览器自动带上 sessionid Cookie
fetch('{% url "toggle_favorite" course_id=course.course_id %}', {
    method: 'POST',
    headers: {'X-CSRFToken': '{{ csrf_token }}'}
})
```

## 2. 服务器如何识别用户并签发 Cookie（或令牌）

- 登录视图：`core/views.py:172–182`
  - 读取 `username/password`
  - `authenticate(request, username, password)` 验证成功后，调用 `login(request, user)`
  - 会话中间件持久化会话并通过响应头 `Set-Cookie` 下发 `sessionid`
  - 后续请求，认证中间件将会话数据映射为 `request.user`

代码片段：

```
user = authenticate(request, username=username, password=password)
if user:
    login(request, user)
    next_url = request.GET.get("next")
    return redirect(next_url or "index")
messages.error(request, "用户名或密码错误")
```

## 3. 服务器如何存储与管理令牌（会话）并关联用户

- 存储：
  - `django_session` 表保存活跃会话（包含 session key 与序列化会话数据）
  - 会话数据中包含已登录用户 ID，认证中间件据此重建 `request.user`
- 访问控制： 
  - 使用 `user.is_authenticated` 判断登录
  - 管理员权限以 `user.is_staff` 判定（管理员查看待审课程、所有状态课程）
  - 写操作视图使用 `@login_required` 保护：`rate_course`、`add_comment`、`add_reaction`、`toggle_favorite`、`report`

代码片段（评价提交受保护）：

```
@login_required
def rate_course(request: HttpRequest, course_id: int):
    existing = Rating.objects.filter(user_id=request.user.id, course_id=course_id).first()
    if existing:
        messages.info(request, "您已评价过该课程，可修改评价。")
        return redirect("course_detail", course_id=course_id)
    # ... 保存评分与标签
```

## 4. 密码正确性校验流程（哈希与比对）

- 注册：`core/views.py:152–170`
  - 使用 `get_user_model().create_user(...)` 创建用户，自动进行密码加盐哈希（PBKDF2）
- 登录：`authenticate(...)`
  - 框架根据用户名取出哈希与盐，对输入密码进行相同算法哈希，比对是否一致
  - 不存储明文密码

注册代码片段：

```
User = get_user_model()
if User.objects.filter(username=username).exists():
    messages.error(request, "用户名已存在")
    return redirect("register")
User.objects.create_user(username=username, email=email, password=password)
messages.success(request, "注册成功，请登录")
```

## 5. 登录/授权流程图（文本版）

```
浏览器                          服务器
  |    GET /login                 |
  |------------------------------>|
  |    渲染表单(含CSRF)           |
  |<------------------------------|
  |    POST /login (csrf,凭证)    |
  |------------------------------>|  authenticate -> 成功
  |    Set-Cookie: sessionid      |  login(); 持久化会话
  |<------------------------------|
  |    后续请求携带 sessionid     |  解析会话 -> request.user
  |------------------------------>|
  |    POST /favorite (AJAX)      |  校验 CSRF + 会话
  |------------------------------>|
  |    GET /logout                |  logout(); 过期会话
  |------------------------------>|  Set-Cookie 过期
  |<------------------------------|
```

## 6. 安全与配置说明

- CSRF：所有修改状态请求均校验 CSRF（表单 `{% csrf_token %}` + AJAX `X-CSRFToken`）
- Cookie 属性：开发环境默认 `HttpOnly`、`SameSite=Lax`；生产可配置 `Secure=True`、更严格 `SameSite` 与 `SESSION_COOKIE_AGE`
- 权限：
  - 管理员 `user.is_staff` 控制审核页与前端列表显示全部课程
  - 如需更细粒度权限，可使用分组与自定义权限（`auth_group` + `user.has_perm`）

## 7. 关键文件索引

- 路由：`core/urls.py:5–10`
- 登录视图：`core/views.py:172–182`
- 注册视图：`core/views.py:152–170`
- 退出视图：`core/views.py:184–186`
- 受保护视图：`core/views.py:187、229、252、266、279`
- 模板登录态显示：`templates/base.html:22–28`
- 设置与中间件：`rate_my_course/settings.py:10–18、20–28、38–43`

